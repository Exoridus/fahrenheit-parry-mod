name: CI/CD

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

permissions:
  contents: write

concurrency:
  group: ci-cd-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: "10.0.x"

jobs:
  verify:
    name: Verify
    runs-on: windows-latest
    if: ${{ github.event_name == 'pull_request' || (github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install make (if missing)
        shell: pwsh
        run: |
          if (-not (Get-Command make -ErrorAction SilentlyContinue)) {
            choco install make -y --no-progress
            $env:Path += ";C:\ProgramData\chocolatey\bin"
          }
          make --version

      - name: Run tests (if any test projects exist)
        shell: pwsh
        run: |
          $testProjects = Get-ChildItem -Recurse -File -Filter *.csproj |
            Where-Object { $_.FullName -notmatch '\\.workspace\\' -and $_.Name -match '(?i)test' }

          if (-not $testProjects -or $testProjects.Count -eq 0) {
            Write-Host "No test projects found. Skipping tests."
            exit 0
          }

          foreach ($proj in $testProjects) {
            Write-Host "Running tests for $($proj.FullName)"
            dotnet test $proj.FullName --configuration Release --nologo
          }

      - name: Build mod (Debug)
        run: make build

  release:
    name: Release Build
    runs-on: windows-latest
    if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Install make (if missing)
        shell: pwsh
        run: |
          if (-not (Get-Command make -ErrorAction SilentlyContinue)) {
            choco install make -y --no-progress
            $env:Path += ";C:\ProgramData\chocolatey\bin"
          }
          make --version

      - name: Bootstrap and integrate vcpkg
        shell: pwsh
        run: |
          if (-not $env:VCPKG_INSTALLATION_ROOT) {
            throw "VCPKG_INSTALLATION_ROOT is not set on this runner."
          }

          Push-Location $env:VCPKG_INSTALLATION_ROOT
          .\bootstrap-vcpkg.bat -disableMetrics
          .\vcpkg integrate install
          Pop-Location

      - name: Full release build
        run: make build-release

      - name: Package release archives
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $repo = $PWD.Path
          $deployRel = Join-Path $repo ".workspace/fahrenheit/artifacts/deploy/rel"
          $modRel = Join-Path $deployRel "mods/fhparry"
          $releaseDir = Join-Path $repo "release"
          $fullRoot = Join-Path $releaseDir "full"
          $modRoot = Join-Path $releaseDir "mod"
          $fullOut = Join-Path $releaseDir "fahrenheit-full-$tag.zip"
          $modOut = Join-Path $releaseDir "fhparry-mod-$tag.zip"

          if (!(Test-Path $deployRel)) { throw "Missing full deploy folder: $deployRel" }
          if (!(Test-Path $modRel)) { throw "Missing mod deploy folder: $modRel" }

          New-Item -ItemType Directory -Force -Path (Join-Path $fullRoot "fahrenheit") | Out-Null
          New-Item -ItemType Directory -Force -Path $modRoot | Out-Null

          robocopy $deployRel (Join-Path $fullRoot "fahrenheit") /E /NFL /NDL /NJH /NJS /NP | Out-Null
          if ($LASTEXITCODE -ge 8) { throw "robocopy failed for full package with code $LASTEXITCODE" }

          robocopy $modRel (Join-Path $modRoot "fhparry") /E /NFL /NDL /NJH /NJS /NP | Out-Null
          if ($LASTEXITCODE -ge 8) { throw "robocopy failed for mod package with code $LASTEXITCODE" }

          if (Test-Path $fullOut) { Remove-Item -Force $fullOut }
          if (Test-Path $modOut) { Remove-Item -Force $modOut }

          Compress-Archive -Path (Join-Path $fullRoot "fahrenheit") -DestinationPath $fullOut
          Compress-Archive -Path (Join-Path $modRoot "fhparry") -DestinationPath $modOut

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            release/fahrenheit-full-${{ github.ref_name }}.zip
            release/fhparry-mod-${{ github.ref_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
