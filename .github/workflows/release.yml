name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: "10.0.x"

jobs:
  release:
    name: Release Build
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Install make (if missing)
        shell: pwsh
        run: |
          if (-not (Get-Command make -ErrorAction SilentlyContinue)) {
            choco install make -y --no-progress
            $env:Path += ";C:\ProgramData\chocolatey\bin"
          }
          make --version

      - name: Bootstrap and integrate vcpkg
        shell: pwsh
        run: |
          if (-not $env:VCPKG_INSTALLATION_ROOT) {
            throw "VCPKG_INSTALLATION_ROOT is not set on this runner."
          }

          Push-Location $env:VCPKG_INSTALLATION_ROOT
          .\bootstrap-vcpkg.bat -disableMetrics
          .\vcpkg integrate install
          Pop-Location

      - name: Full release build
        run: make build BUILD_TARGET=full CONFIGURATION=Release

      - name: Package release archives
        shell: cmd
        run: scripts\package-release.cmd --tag "${{ github.ref_name }}" --deploy-dir ".workspace\fahrenheit\artifacts\deploy\rel" --mod-id "fhparry" --out-dir ".release"

      - name: Generate release notes
        shell: cmd
        run: scripts\generate-release-notes.cmd --tag "${{ github.ref_name }}" --repo "${{ github.repository }}" --out ".release\release-notes.txt"

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          body_path: .release/release-notes.txt
          files: |
            .release/fahrenheit-full-${{ github.ref_name }}.zip
            .release/fhparry-mod-${{ github.ref_name }}.zip
            .release/fahrenheit-full-${{ github.ref_name }}.zip.sha256
            .release/fhparry-mod-${{ github.ref_name }}.zip.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
