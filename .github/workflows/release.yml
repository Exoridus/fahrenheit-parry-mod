name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: "10.0.x"

jobs:
  release:
    name: Release Build
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache vcpkg archives
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\vcpkg\archives
          key: windows-vcpkg-${{ hashFiles('fahrenheit.release.ref', 'build.proj') }}
          restore-keys: |
            windows-vcpkg-

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Bootstrap and integrate vcpkg
        shell: cmd
        run: |
          if "%VCPKG_INSTALLATION_ROOT%"=="" (
            echo ERROR: VCPKG_INSTALLATION_ROOT is not set on this runner.
            exit /B 1
          )
          pushd "%VCPKG_INSTALLATION_ROOT%"
          call bootstrap-vcpkg.bat -disableMetrics
          if errorlevel 1 exit /B 1
          call vcpkg integrate install
          if errorlevel 1 exit /B 1
          popd

      - name: Full release build
        shell: cmd
        run: build.cmd buildrelease --repository "${{ github.repository }}"

      - name: Package release archives
        shell: cmd
        run: build.cmd packagerelease --tag "${{ github.ref_name }}" --deploydir ".workspace\fahrenheit\artifacts\deploy\rel" --outdir ".release"

      - name: Generate release notes
        shell: cmd
        run: build.cmd generatereleasenotes --tag "${{ github.ref_name }}" --repository "${{ github.repository }}" --output ".release\release-notes.txt"

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          body_path: .release/release-notes.txt
          files: |
            .release/fahrenheit-full-${{ github.ref_name }}.zip
            .release/fhparry-mod-${{ github.ref_name }}.zip
            .release/fahrenheit-full-${{ github.ref_name }}.zip.sha256
            .release/fhparry-mod-${{ github.ref_name }}.zip.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
